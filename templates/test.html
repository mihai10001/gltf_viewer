<!doctype html>
<html lang="en">
  <head>
    <!-- Required meta tags -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">

    <style>

    html, body {
      height: 100%;
    }

    canvas {
      padding-left: 0;
      padding-right: 0;
      margin-left: auto;
      margin-right: auto;
      display: block;
      border-radius: 5px;
    }

    </style>
    <!-- Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css" integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">

    <title>glTF loader (viewer)</title>
  </head>
  <body class="bg-dark">

    <div class="container fixed-top rounded border-bottom border-secondary bg-dark text-right">
      <div class="h2 mt-2 text-warning">Simple glTF Viewer <i class="fas fa-cube"></i></div>
      <div class="h3 mb-1 text-secondary">with <i class="fab fa-js-square"></i> and <i class="fab fa-python"></i></div>
    </div>

<!--     <div id="info">
        <a href="http://threejs.org" target="_blank" rel="noopener">three.js</a> - GLTFLoader<br />
        Battle Damaged Sci-fi Helmet by
        <a href="https://sketchfab.com/theblueturtle_" target="_blank" rel="noopener">theblueturtle_</a><br />
        <a href="https://hdrihaven.com/hdri/?h=pedestrian_overpass" target="_blank" rel="noopener">Pedestrian Overpass</a> by <a href="https://hdrihaven.com/" target="_blank" rel="noopener">HDRI Haven</a>
    </div> -->

    <div class="my-5 text-dark" id="after">empty</div>

    <div class="container mt-4 p-2 rounded position-relative bg-warning" id="placeholder">
      <div class="h3 p-2 text-center">Interact with the canvas below:</div>
      <div class="h5 text-left position-absolute">
        <div>Mouse controls (using the 'OrbitControls.js' module) </div>
        <div>Left mouse and drag to</div>
        <div>move</div>
      </div>

      <div class="h5 position-absolute" style="right: 0">
        <div>The canvas was built using Three.js/examples</div>
        <div>The canvas is built with a script that first loads</div>
        <div>THE MAP AS A TEXTURE (.hdri) and then</div>
        <div>THE glTF MODEL (.gltf)</div>
        <div>move</div>
      </div>
    </div>

    <div class="container mx-auto my-3 rounded bg-warning">

      <div class="row p-2">
        <div class="col-lg-5 mx-auto p-2 bg-info rounded">
          <form method="POST">
            <div class="form-group text-center" method="POST">
              <label for="this_select">Select model from the list below</label>
              <select class="form-control" id="this_select" name="model_select">
                {% for model in all_models %}
                  <option>{{ model }}</option>
                {% endfor %}
              </select>
            </div>
            <button type="submit" class="btn btn-dark btn-block">Submit</button>
          </form>
        </div>

        <div class="col-lg-5 mx-auto my-2 bg-info rounded">
        </div>
      </div>


    </div>

    <script src="js/three/build/three.js"></script>

    <script src="js/three/controls/OrbitControls.js"></script>
    <script src="js/three/loaders/GLTFLoader.js"></script>

    <script src="js/three/loaders/EquirectangularToCubeGenerator.js"></script>
    <script src="js/three/loaders/RGBELoader.js"></script>

    <script src="js/three/pmrem/PMREMGenerator.js"></script>
    <script src="js/three/pmrem/PMREMCubeUVPacker.js"></script>

    <script src="js/three/WebGL.js"></script>
    <script src="js/three/libs/stats.min.js"></script>

    <script>
      if ( WEBGL.isWebGLAvailable() === false ) {
          document.body.appendChild( WEBGL.getWebGLErrorMessage() );
      }

      function insertAfter(newNode, referenceNode) {
          referenceNode.parentNode.insertBefore(newNode, referenceNode.nextSibling);
      }

      var container, stats, controls;
      var camera, scene, renderer;
      init();
      animate();
      function init() {
          nav = document.getElementById('after');
          container = document.getElementById('placeholder');
          container.height = window.innerHeight/1.75;
          container.width = window.innerWidth/3.5;
          insertAfter(container, nav);

          camera = new THREE.PerspectiveCamera( 90, (window.innerHeight/1.75) / (window.innerWidth/3.5), 0.1, 200 );
          camera.position.set( -1.8, 0.9, 0.9 );
          scene = new THREE.Scene();
          var loader = new THREE.RGBELoader().setPath( 'js/textures/equirectangular/' );
          loader.load( 'shanghai_bund_4k.hdr', function ( texture ) {
              texture.encoding = THREE.RGBEEncoding;
              texture.minFilter = THREE.NearestFilter;
              texture.magFilter = THREE.NearestFilter;
              texture.flipY = true;
              var cubeGenerator = new THREE.EquirectangularToCubeGenerator( texture, { resolution: 2048 } );
              cubeGenerator.update( renderer );
              var pmremGenerator = new THREE.PMREMGenerator( cubeGenerator.renderTarget.texture );
              pmremGenerator.update( renderer );
              var pmremCubeUVPacker = new THREE.PMREMCubeUVPacker( pmremGenerator.cubeLods );
              pmremCubeUVPacker.update( renderer );
              var envMap = pmremCubeUVPacker.CubeUVRenderTarget.texture;
              // model
              var loader = new THREE.GLTFLoader().setPath( '{{ model_dir_path }}' );
              loader.load( '{{ model_file_path }}', function ( gltf ) {
                  gltf.scene.traverse( function ( child ) {
                      if ( child.isMesh ) {
                          child.material.envMap = envMap;
                      }
                  } );
                  scene.add( gltf.scene );
              } );
              pmremGenerator.dispose();
              pmremCubeUVPacker.dispose();
              scene.background = cubeGenerator.renderTarget;
          } );
          renderer = new THREE.WebGLRenderer( { antialias: true } );
          renderer.setPixelRatio( window.devicePixelRatio );
          renderer.setSize( container.width, container.height );
          renderer.gammaOutput = true;

          controls = new THREE.OrbitControls( camera, renderer.domElement );
          controls.target.set( 0, - 0.2, - 0.2 );
          controls.update();

          stats = container.appendChild( renderer.domElement );
          container.addEventListener( 'resize', onWindowResize, false );
          // stats
          stats = new Stats();
          container.appendChild( stats.dom );
      }
      function onWindowResize() {
          camera.aspect = (window.innerHeight/1.75) / (window.innerWidth/3.75);
          camera.updateProjectionMatrix();
          renderer.setSize( window.innerWidth/3.75, window.innerHeight/1.75 );
      }
      //
      function animate() {
          requestAnimationFrame( animate );
          renderer.render( scene, camera );
          stats.update();
      }
    </script>


    <!-- Optional JavaScript -->
    <!-- jQuery first, then Popper.js, then Bootstrap JS, then FontAwesome-->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.7/umd/popper.min.js" integrity="sha384-UO2eT0CpHqdSJQ6hJty5KVphtPhzWj9WO1clHTMGa3JDZwrnQq4sF86dIHNDz0W1" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/js/bootstrap.min.js" integrity="sha384-JjSmVgyd0p3pXB1rRibZUAYoIIy6OrQ6VrjIEaFf/nJGzIxFDsf4x0xIM+B07jRM" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://use.fontawesome.com/releases/v5.8.1/css/all.css" integrity="sha384-50oBUHEmvpQ+1lW4y57PTFmhCaXp0ML5d60M1M7uH2+nqUivzIebhndOJK28anvf" crossorigin="anonymous">
  </body>
</html>
